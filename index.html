<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stripe Checkout</title>
  <style>
    /* Pastikan form tidak terlalu besar di skrin kecil */
    body {
      font-family: sans-serif;
      padding: 16px;
      margin: 0;
      box-sizing: border-box;
    }

    .pay-btn {
      padding: 10px 16px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.3s;
      width: 48%; /* Menyusun dua butang dalam satu baris */
      margin-bottom: 10px;
    }

    .pay-btn:hover {
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .pay-btn img {
      display: block;
      margin: auto;
      max-width: 100%; /* Membenarkan imej untuk disesuaikan dengan lebar butang */
    }

    /* Form utama */
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 24px;
      border: 1px solid #eee;
      border-radius: 12px;
    }

    /* Aturan responsif untuk peranti mudah alih */
    @media (max-width: 600px) {
      .form-container {
        padding: 16px;
      }

      .pay-btn {
        width: 100%; /* Butang pembayaran akan mengisi lebar penuh di peranti mudah alih */
      }

      h2 {
        font-size: 1.5em; /* Saiz tajuk lebih kecil di mobile */
      }

      p {
        font-size: 1em; /* Saiz teks lebih kecil di mobile */
      }
    }

    /* Styling untuk input dan select */
    input, select {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      box-sizing: border-box; /* Pastikan padding tidak melebihi lebar elemen */
    }

    h3 {
      margin-top: 24px;
    }
  </style>
</head>

<body>
  <div class="form-container">
    <h2>Shipping Information</h2>
    
    <!-- Input untuk Nama dan Nombor Telefon -->
    <input id="fullName" placeholder="Full Name">
    <input id="phone" placeholder="Phone Number">

    <!-- Input untuk Alamat dan Postcode -->
    <input id="address" placeholder="Shipping Address">
    <input id="postcode" placeholder="Postcode">

    <!-- Input untuk City -->
    <input id="city" placeholder="City">

    <!-- Dropdown untuk State (Negeri) - Diletakkan selepas City -->
    <select id="state">
      <option value="">Select State</option>
      <!-- Semenanjung Malaysia -->
      <option value="selangor">Selangor</option>
      <option value="johor">Johor</option>
      <option value="kedah">Kedah</option>
      <option value="kelantan">Kelantan</option>
      <option value="melaka">Melaka</option>
      <option value="negeri sembilan">Negeri Sembilan</option>
      <option value="pahang">Pahang</option>
      <option value="perak">Perak</option>
      <option value="perlis">Perlis</option>
      <option value="pulau pinang">Pulau Pinang</option>
      <option value="terengganu">Terengganu</option>
      <option value="kuala lumpur">Kuala Lumpur</option>
      <option value="putrajaya">Putrajaya</option>

      <!-- Sabah & Sarawak -->
      <option value="sabah">Sabah</option>
      <option value="sarawak">Sarawak</option>
      <option value="labuan">Labuan</option>

      <!-- Pilihan "Other" untuk negeri yang tidak terdapat dalam senarai -->
      <option value="other">Other</option>
    </select>

    <!-- Input untuk State (manual, jika bukan Malaysia) -->
    <input id="stateManual" placeholder="State (if not Malaysia)" style="display: none;">

    <!-- Form Negara di atas state -->
    <h3>Country</h3>
    <select id="country">
      <option value="">Select Country</option>
      <option value="malaysia">Malaysia</option>
      <option value="other">Other</option>
    </select>

    <h3>Order Summary</h3>
    <p>Item: <strong>PLAIN SQUARE - BREEZY BEACH PLUM</strong></p>
    <p>Item Price: <strong>RM <span id="itemAmount">29.90</span></strong></p>
    <p>Shipping: <strong>RM <span id="shippingFee">0.00</span></strong></p>
    <p>Total: <strong>RM <span id="totalAmount">29.90</span></strong></p>

    <h3>Choose Payment Method</h3>
    <div>
      <button onclick="pay('fpx')" class="pay-btn"><img src="FPX-Logo.png" alt="FPX"></button>
      <button onclick="pay('card')" class="pay-btn"><img src="visa-card.png" alt="Card"></button>
    </div>
  </div>

  <script>
    const itemPrice = 29.90;  // Harga item dalam MYR
    const itemAmountInSen = 2990; // Harga item dalam sen (RM29.90 = 2990 sen)

    // Daftar negeri dan harga penghantaran berdasarkan negeri
    const shippingRates = {
      "selangor": 1000, // RM10 untuk Selangor
      "johor": 1000, // RM10 untuk Johor
      "kedah": 1000, // RM10 untuk Kedah
      "kelantan": 1000, // RM10 untuk Kelantan
      "melaka": 1000, // RM10 untuk Melaka
      "negeri sembilan": 1000, // RM10 untuk Negeri Sembilan
      "pahang": 1000, // RM10 untuk Pahang
      "perak": 1000, // RM10 untuk Perak
      "perlis": 1000, // RM10 untuk Perlis
      "pulau pinang": 1000, // RM10 untuk Pulau Pinang
      "terengganu": 1000, // RM10 untuk Terengganu
      "kuala lumpur": 1000, // RM10 untuk Kuala Lumpur
      "putrajaya": 1000, // RM10 untuk Putrajaya

      // Sabah & Sarawak
      "sabah": 1900, // RM19 untuk Sabah
      "sarawak": 1900, // RM19 untuk Sarawak
      "labuan": 1900  // RM19 untuk Labuan
    };

    // Fungsi untuk kemas kini harga penghantaran dan jumlah total
    function updateShippingFeeAndTotal(state) {
      let shipping = 0;

      // Semak berdasarkan negeri
      state = state.toLowerCase(); // Pastikan tiada masalah case-sensitive

      // Tentukan harga penghantaran berdasarkan negeri
      if (shippingRates[state]) {
        shipping = shippingRates[state]; // Dapatkan harga penghantaran dari `shippingRates`
      } else {
        // Jika tidak sah, set penghantaran kepada RM0
        shipping = 0;
      }

      // Kemas kini shipping fee dan total amount
      if (shipping > 0) {
        document.getElementById("shippingFee").textContent = (shipping / 100).toFixed(2); // Kemaskini penghantaran
        const total = itemPrice + shipping / 100; // Kira jumlah total
        document.getElementById("totalAmount").textContent = total.toFixed(2); // Kemaskini total
      } else {
        // Jika tidak sah, set penghantaran kepada RM0
        document.getElementById("shippingFee").textContent = "0.00";
        document.getElementById("totalAmount").textContent = itemPrice.toFixed(2);
      }
    }

    // Kemaskini penghantaran apabila negeri dipilih atau ditulis
    document.getElementById("state").addEventListener("change", function () {
      const stateInput = document.getElementById("state").value.trim(); // Ambil nilai negeri
      updateShippingFeeAndTotal(stateInput);  // Kemas kini penghantaran berdasarkan negeri yang dipilih
    });

    // Kemaskini penghantaran apabila negara dipilih
    document.getElementById("country").addEventListener("change", function () {
      const country = document.getElementById("country").value;
      
      // Jika Malaysia dipilih, tunjukkan dropdown state
      if (country === "malaysia") {
        document.getElementById("state").style.display = "block";
        document.getElementById("stateManual").style.display = "none";
      } else {
        // Jika bukan Malaysia, tunjukkan input manual untuk state
        document.getElementById("state").style.display = "none";
        document.getElementById("stateManual").style.display = "block";
      }
    });

    // Fungsi pembayaran apabila kaedah dipilih
    async function pay(method) {
      // Ambil data penghantaran
      const shipping = parseFloat(document.getElementById("shippingFee").textContent) * 100; // Tukar kepada sen
      const totalAmount = itemAmountInSen + shipping; // Jumlah dalam sen

      const body = {
        method: method,
        amount: totalAmount, // Jumlah pembayaran termasuk shipping
        product: "PLAIN SQUARE - BREEZY BEACH PLUM", // Nama produk
        customer: {
          name: document.getElementById("fullName").value,
          phone: document.getElementById("phone").value, // Ambil nombor telefon
          address: document.getElementById("address").value,
          postcode: document.getElementById("postcode").value,
          state: document.getElementById("state").value || document.getElementById("stateManual").value,  // Ambil nilai state
          city: document.getElementById("city").value,
        }
      };

      // Panggil API untuk mencipta sesi pembayaran
      const res = await fetch("/api/checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      if (data?.url) {
        window.location.href = data.url; // Redirect ke halaman pembayaran Stripe
      } else {
        alert("Error creating payment session.");
      }
    }
  </script>
</body>
</html>
