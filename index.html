<div style="max-width: 600px; margin: auto; font-family: sans-serif; padding: 24px; border: 1px solid #eee; border-radius: 12px;">
  <h2>Shipping Information</h2>
  <input id="fullName" placeholder="Full Name" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="phone" placeholder="Phone Number" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="address" placeholder="Shipping Address" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="postcode" placeholder="Postcode" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="city" placeholder="City" style="width: 100%; margin-bottom: 12px; padding: 8px;">

  <h3>Order Summary</h3>
  <p>Item: <strong>PLAIN SQUARE - BREEZY BEACH PLUM</strong></p>
  <p>Item Price: <strong>RM <span id="itemAmount">29.90</span></strong></p>
  <p>Shipping: <strong>RM <span id="shippingFee">0.00</span></strong></p>
  <p>Total: <strong>RM <span id="totalAmount">29.90</span></strong></p>

  <h3 style="margin-top: 24px;">Choose Payment Method</h3>
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px;">
    <button onclick="pay('fpx')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687676bd4a954276e81fb144/1752594109396/FPX-Logo.png" height="24" alt="FPX"></button>
    <button onclick="pay('grabpay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/68767787089e8e235490babc/1752594311288/GrabPay_Final_Logo_RGB_green_StackedVersion-01.png" height="24" alt="GrabPay"></button>
    <button onclick="pay('alipay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677c00057f916c516c4ca/1752594368748/62b1e77b56b6848f8bec9031.png" height="24" alt="Alipay"></button>
    <button onclick="pay('card')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677f99df7ce1477a1b709/1752594425883/credit-or-debit-card-visa-mastercard-logo-hd-transparent-png--comdlpng6953127.jpg" height="24" alt="Card"></button>
  </div>
</div>

<style>
  .pay-btn {
    padding: 10px 16px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  .pay-btn:hover {
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
  }
  .pay-btn img {
    display: block;
    margin: auto;
  }
</style>

<script>
  const itemPrice = 29.90;  // Harga item
  const itemAmountInSen = 2990; // Harga item dalam sen (RM29.90 = 2990 sen)

  // Senarai Postcode Malaysia
  const westMalaysiaPostcodes = [
    "10000", "10100", "10200", "10300", "10400", "10500", "10600", "10700", "10800", "10900", "11000", "20000", "20100", "20200", "20300", "20400", "20500", "20600", "30000", "30100", "30200", "30300", "30400", "40000", "40100", "40200", "40300", "40400", "40500", "40600", "50000", "50100", "50200", "50300", "50400", "50500", "60000", "60100", "60200", "60300", "60400", "60500", "70000", "70100", "70200", "70300", "70400", "70500", "80000", "80100", "80200", "80300", "80400", "80500", "90000", "90100", "90200", "90300", "90400", "90500"
  ];

  const eastMalaysiaPostcodes = [
    "88000", "88100", "88200", "88300", "88400", "88500", "88600", "88700", "88800", "88900", "89000", "89100", "89200", "89300", "89400", "89500", "89600", "89700", "89800", "89900", "90000", "90100", "90200", "90300", "90400", "90500", "90600", "90700", "90800", "90900", "91000", "91100", "91200", "91300", "91400", "91500", "93000", "93100", "93200", "93300", "93400", "93500", "93600", "93700", "93800", "93900"
  ];

  // Kemaskini shipping fee dan total amount apabila pengguna memilih penghantaran
  document.getElementById("postcode").addEventListener("input", function () {
    const postcode = document.getElementById("postcode").value.trim(); // Pastikan tiada ruang kosong

    console.log("Postcode entered:", postcode);  // Debug: pastikan postcode diset dengan betul

    let shipping = 0;

    // Semenanjung Malaysia (RM10 shipping)
    if (westMalaysiaPostcodes.includes(postcode)) {
      shipping = 1000; // RM10 = 1000 sen
    } 
    // Sabah & Sarawak (RM19 shipping)
    else if (eastMalaysiaPostcodes.includes(postcode)) {
      shipping = 1900; // RM19 = 1900 sen
    }

    // Kemas kini shipping fee dan total amount
    if (shipping > 0) {
      document.getElementById("shippingFee").textContent = (shipping / 100).toFixed(2); // Kemaskini penghantaran
      const total = itemPrice + shipping / 100; // Kira jumlah total
      document.getElementById("totalAmount").textContent = total.toFixed(2); // Kemaskini total
    } else {
      // Jika tidak sah, set penghantaran kepada RM0
      document.getElementById("shippingFee").textContent = "0.00";
      document.getElementById("totalAmount").textContent = itemPrice.toFixed(2);
    }
  });

  // Fungsi pembayaran apabila kaedah dipilih
  async function pay(method) {
    // Ambil data penghantaran
    const shipping = parseFloat(document.getElementById("shippingFee").textContent) * 100; // Tukar kepada sen
    const totalAmount = itemAmountInSen + shipping; // Jumlah dalam sen

    const body = {
      method: method,
      amount: totalAmount, // Jumlah pembayaran termasuk shipping
      product: "PLAIN SQUARE - BREEZY BEACH PLUM", // Nama produk
      customer: {
        name: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value, // Ambil nombor telefon
        address: document.getElementById("address").value,
        postcode: document.getElementById("postcode").value,
        city: document.getElementById("city").value,
      }
    };

    // Panggil API untuk mencipta sesi pembayaran
    const res = await fetch("/api/checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (data?.url) {
      window.location.href = data.url; // Redirect ke halaman pembayaran Stripe
    } else {
      alert("Error creating payment session.");
    }
  }
</script>
