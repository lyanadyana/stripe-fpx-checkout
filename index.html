<div style="max-width: 600px; margin: auto; font-family: sans-serif; padding: 24px; border: 1px solid #eee; border-radius: 12px;">
  <h2>Shipping Information</h2>
  <input id="fullName" placeholder="Full Name" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="phone" placeholder="Phone Number" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="address" placeholder="Shipping Address" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  
  <!-- Menambah pilihan state untuk penghantaran -->
  <select id="state" style="width: 100%; margin-bottom: 12px; padding: 8px;">
    <option value="semenanjung">Semenanjung Malaysia (RM10)</option>
    <option value="sabah_sarawak">Sabah/Sarawak (RM19)</option>
  </select>

  <input id="city" placeholder="City" style="width: 100%; margin-bottom: 12px; padding: 8px;">

  <h3>Order Summary</h3>
  <p>Item: <strong>PLAIN SQUARE - BREEZY BEACH PLUM</strong></p>
  <p>Item Price: <strong>RM <span id="itemAmount">29.90</span></strong></p>
  <p>Shipping: <strong>RM <span id="shippingFee">0.00</span></strong></p>
  <p>Total: <strong>RM <span id="totalAmount">29.90</span></strong></p>

  <h3 style="margin-top: 24px;">Choose Payment Method</h3>
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px;">
    <button onclick="pay('fpx')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687676bd4a954276e81fb144/1752594109396/FPX-Logo.png" height="24" alt="FPX"></button>
    <button onclick="pay('grabpay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/68767787089e8e235490babc/1752594311288/GrabPay_Final_Logo_RGB_green_StackedVersion-01.png" height="24" alt="GrabPay"></button>
    <button onclick="pay('alipay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677c00057f916c516c4ca/1752594368748/62b1e77b56b6848f8bec9031.png" height="24" alt="Alipay"></button>
    <button onclick="pay('card')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677f99df7ce1477a1b709/1752594425883/credit-or-debit-card-visa-mastercard-logo-hd-transparent-png--comdlpng6953127.jpg" height="24" alt="Card"></button>
  </div>
</div>

<style>
  .pay-btn {
    padding: 10px 16px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  .pay-btn:hover {
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
  }
  .pay-btn img {
    display: block;
    margin: auto;
  }
</style>

<script>
  const itemPrice = 29.90;  // Harga item dalam MYR
  const itemAmountInSen = 2990; // Harga item dalam sen (RM29.90 = 2990 sen)

  // Kemas kini harga penghantaran dan jumlah total apabila pengguna memilih state
  document.getElementById("state").addEventListener("change", function () {
    const selectedState = document.getElementById("state").value; // Ambil nilai state yang dipilih

    let shipping = 0;

    // Semenanjung Malaysia (RM10 penghantaran)
    if (selectedState === "semenanjung") {
      shipping = 1000; // RM10 = 1000 sen
    } 
    // Sabah & Sarawak (RM19 penghantaran)
    else if (selectedState === "sabah_sarawak") {
      shipping = 1900; // RM19 = 1900 sen
    }

    // Kemas kini shipping fee dan total amount
    if (shipping > 0) {
      document.getElementById("shippingFee").textContent = (shipping / 100).toFixed(2); // Kemaskini penghantaran
      const total = itemPrice + shipping / 100; // Kira jumlah total
      document.getElementById("totalAmount").textContent = total.toFixed(2); // Kemaskini total
    } else {
      // Jika tidak sah, set penghantaran kepada RM0
      document.getElementById("shippingFee").textContent = "0.00";
      document.getElementById("totalAmount").textContent = itemPrice.toFixed(2);
    }
  });

  // Fungsi pembayaran apabila kaedah dipilih
  async function pay(method) {
    // Ambil data penghantaran
    const shipping = parseFloat(document.getElementById("shippingFee").textContent) * 100; // Tukar kepada sen
    const totalAmount = itemAmountInSen + shipping; // Jumlah dalam sen

    const body = {
      method: method,
      amount: totalAmount, // Jumlah pembayaran termasuk shipping
      product: "PLAIN SQUARE - BREEZY BEACH PLUM", // Nama produk
      customer: {
        name: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value, // Ambil nombor telefon
        address: document.getElementById("address").value,
        state: document.getElementById("state").value,  // Ambil nilai state
        city: document.getElementById("city").value,
      }
    };

    // Panggil API untuk mencipta sesi pembayaran
    const res = await fetch("/api/checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (data?.url) {
      window.location.href = data.url; // Redirect ke halaman pembayaran Stripe
    } else {
      alert("Error creating payment session.");
    }
  }
</script>
