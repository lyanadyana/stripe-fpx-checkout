<div style="max-width: 600px; margin: auto; font-family: sans-serif; padding: 24px; border: 1px solid #eee; border-radius: 12px;">
  <h2>Shipping Information</h2>
  <input id="fullName" placeholder="Full Name" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="phone" placeholder="Phone Number" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  <input id="address" placeholder="Shipping Address" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  
  <!-- Input untuk Postcode -->
  <input id="postcode" placeholder="Postcode" style="width: 100%; margin-bottom: 12px; padding: 8px;">
  
  <!-- Input untuk City -->
  <input id="city" placeholder="City" style="width: 100%; margin-bottom: 12px; padding: 8px;">

  <!-- Dropdown untuk State (Negeri) - Diletakkan selepas City -->
  <select id="state" style="width: 100%; margin-bottom: 12px; padding: 8px;">
    <option value="">Select State</option>
    <!-- Semenanjung Malaysia -->
    <option value="selangor">Selangor</option>
    <option value="johor">Johor</option>
    <option value="kedah">Kedah</option>
    <option value="kelantan">Kelantan</option>
    <option value="melaka">Melaka</option>
    <option value="negeri sembilan">Negeri Sembilan</option>
    <option value="pahang">Pahang</option>
    <option value="perak">Perak</option>
    <option value="perlis">Perlis</option>
    <option value="pulau pinang">Pulau Pinang</option>
    <option value="terengganu">Terengganu</option>
    <option value="kuala lumpur">Kuala Lumpur</option>
    <option value="putrajaya">Putrajaya</option>

    <!-- Sabah & Sarawak -->
    <option value="sabah">Sabah</option>
    <option value="sarawak">Sarawak</option>
    <option value="labuan">Labuan</option>

    <!-- Pilihan "Other" untuk negeri yang tidak terdapat dalam senarai -->
    <option value="other">Other</option>
  </select>

  <!-- Input untuk State (manual, jika bukan Malaysia) -->
  <input id="stateManual" placeholder="State (if not Malaysia)" style="width: 100%; margin-bottom: 12px; padding: 8px; display: none;">

  <!-- Form Negara di bawah state -->
  <h3>Country</h3>
  <select id="country" style="width: 100%; margin-bottom: 12px; padding: 8px;">
    <option value="">Select Country</option>
    <option value="malaysia">Malaysia</option>
    <option value="other">Other</option>
  </select>

  <h3>Order Summary</h3>
  <p>Item: <strong>PLAIN SQUARE - BREEZY BEACH PLUM</strong></p>
  <p>Item Price: <strong>RM <span id="itemAmount">29.90</span></strong></p>
  <p>Shipping: <strong>RM <span id="shippingFee">0.00</span></strong></p>
  <p>Total: <strong>RM <span id="totalAmount">29.90</span></strong></p>

  <h3 style="margin-top: 24px;">Choose Payment Method</h3>
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px;">
    <button onclick="pay('fpx')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687676bd4a954276e81fb144/1752594109396/FPX-Logo.png" height="24" alt="FPX"></button>
    <button onclick="pay('grabpay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/68767787089e8e235490babc/1752594311288/GrabPay_Final_Logo_RGB_green_StackedVersion-01.png" height="24" alt="GrabPay"></button>
    <button onclick="pay('alipay')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677c00057f916c516c4ca/1752594368748/62b1e77b56b6848f8bec9031.png" height="24" alt="Alipay"></button>
    <button onclick="pay('card')" class="pay-btn"><img src="https://static1.squarespace.com/static/6832bef596c05e4a77e1dd4f/t/687677f99df7ce1477a1b709/1752594425883/credit-or-debit-card-visa-mastercard-logo-hd-transparent-png--comdlpng6953127.jpg" height="24" alt="Card"></button>
  </div>
</div>

<style>
  .pay-btn {
    padding: 10px 16px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  .pay-btn:hover {
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
  }
  .pay-btn img {
    display: block;
    margin: auto;
  }
</style>

<script>
  const itemPrice = 29.90;  // Harga item dalam MYR
  const itemAmountInSen = 2990; // Harga item dalam sen (RM29.90 = 2990 sen)

  // Daftar negeri dan harga penghantaran berdasarkan negeri
  const shippingRates = {
    "selangor": 1000, // RM10 untuk Selangor
    "johor": 1000, // RM10 untuk Johor
    "kedah": 1000, // RM10 untuk Kedah
    "kelantan": 1000, // RM10 untuk Kelantan
    "melaka": 1000, // RM10 untuk Melaka
    "negeri sembilan": 1000, // RM10 untuk Negeri Sembilan
    "pahang": 1000, // RM10 untuk Pahang
    "perak": 1000, // RM10 untuk Perak
    "perlis": 1000, // RM10 untuk Perlis
    "pulau pinang": 1000, // RM10 untuk Pulau Pinang
    "terengganu": 1000, // RM10 untuk Terengganu
    "kuala lumpur": 1000, // RM10 untuk Kuala Lumpur
    "putrajaya": 1000, // RM10 untuk Putrajaya

    // Sabah & Sarawak
    "sabah": 1900, // RM19 untuk Sabah
    "sarawak": 1900, // RM19 untuk Sarawak
    "labuan": 1900  // RM19 untuk Labuan
  };

  // Fungsi untuk kemas kini harga penghantaran dan jumlah total
  function updateShippingFeeAndTotal(state) {
    let shipping = 0;

    // Semak berdasarkan negeri
    state = state.toLowerCase(); // Pastikan tiada masalah case-sensitive

    // Tentukan harga penghantaran berdasarkan negeri
    if (shippingRates[state]) {
      shipping = shippingRates[state]; // Dapatkan harga penghantaran dari `shippingRates`
    } else {
      // Jika tidak sah, set penghantaran kepada RM0
      shipping = 0;
    }

    // Kemas kini shipping fee dan total amount
    if (shipping > 0) {
      document.getElementById("shippingFee").textContent = (shipping / 100).toFixed(2); // Kemaskini penghantaran
      const total = itemPrice + shipping / 100; // Kira jumlah total
      document.getElementById("totalAmount").textContent = total.toFixed(2); // Kemaskini total
    } else {
      // Jika tidak sah, set penghantaran kepada RM0
      document.getElementById("shippingFee").textContent = "0.00";
      document.getElementById("totalAmount").textContent = itemPrice.toFixed(2);
    }
  }

  // Kemaskini penghantaran apabila negeri dipilih atau ditulis
  document.getElementById("state").addEventListener("change", function () {
    const stateInput = document.getElementById("state").value.trim(); // Ambil nilai negeri
    updateShippingFeeAndTotal(stateInput);  // Kemas kini penghantaran berdasarkan negeri yang dipilih
  });

  // Kemaskini penghantaran apabila negara dipilih
  document.getElementById("country").addEventListener("change", function () {
    const country = document.getElementById("country").value;
    
    // Jika Malaysia dipilih, tunjukkan dropdown state
    if (country === "malaysia") {
      document.getElementById("state").style.display = "block";
      document.getElementById("stateManual").style.display = "none";
    } else {
      // Jika bukan Malaysia, tunjukkan input manual untuk state
      document.getElementById("state").style.display = "none";
      document.getElementById("stateManual").style.display = "block";
    }
  });

  // Fungsi pembayaran apabila kaedah dipilih
  async function pay(method) {
    // Ambil data penghantaran
    const shipping = parseFloat(document.getElementById("shippingFee").textContent) * 100; // Tukar kepada sen
    const totalAmount = itemAmountInSen + shipping; // Jumlah dalam sen

    const body = {
      method: method,
      amount: totalAmount, // Jumlah pembayaran termasuk shipping
      product: "PLAIN SQUARE - BREEZY BEACH PLUM", // Nama produk
      customer: {
        name: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value, // Ambil nombor telefon
        address: document.getElementById("address").value,
        postcode: document.getElementById("postcode").value,
        state: document.getElementById("state").value || document.getElementById("stateManual").value,  // Ambil nilai state
        city: document.getElementById("city").value,
      }
    };

    // Panggil API untuk mencipta sesi pembayaran
    const res = await fetch("/api/checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (data?.url) {
      window.location.href = data.url; // Redirect ke halaman pembayaran Stripe
    } else {
      alert("Error creating payment session.");
    }
  }
</script>
